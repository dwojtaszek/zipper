#!/bin/bash
# Pre-push git hook — runs unit tests + basic E2E smoke suite
# Installs to: .git/hooks/pre-push
#
# Full E2E + coverage checks run in CI.
# To bypass (not recommended): git push --no-verify

echo "┌─────────────────────────────────────────────┐"
echo "│  Pre-push: Unit Tests + Basic E2E Smoke     │"
echo "└─────────────────────────────────────────────┘"

# ──────────────────────────────────────────────────
# 1. Run unit tests (fast gate)
# ──────────────────────────────────────────────────
echo ""
echo "▶ Running unit tests..."

if ! command -v dotnet >/dev/null 2>&1; then
    echo "⚠️  dotnet not found, skipping tests"
    exit 0
fi

dotnet test src/Zipper.Tests/Zipper.Tests.csproj \
    --logger "console;verbosity=quiet" \
    --nologo \
    2>/dev/null || {
    echo ""
    echo "❌ Unit tests failed. Push aborted."
    echo "   Run 'dotnet test' for details."
    echo "   To bypass: git push --no-verify"
    exit 1
}
echo "✅ Unit tests passed"

# ──────────────────────────────────────────────────
# 2. Run basic E2E smoke suite (5 representative cases)
# ──────────────────────────────────────────────────
echo ""
echo "▶ Running basic E2E smoke tests..."

# Detect OS and run appropriate script
case "$(uname -s)" in
    Linux*|Darwin*)
        if [ -x "./tests/run-e2e-basic.sh" ] || [ -f "./tests/run-e2e-basic.sh" ]; then
            chmod +x ./tests/run-e2e-basic.sh
            bash ./tests/run-e2e-basic.sh || {
                echo ""
                echo "❌ Basic E2E smoke tests failed. Push aborted."
                echo "   Run 'bash tests/run-e2e-basic.sh' for details."
                echo "   To bypass: git push --no-verify"
                exit 1
            }
        else
            echo "⚠️  tests/run-e2e-basic.sh not found, skipping E2E"
        fi
        ;;
    MINGW*|MSYS*|CYGWIN*)
        if [ -f "./tests/run-e2e-basic.bat" ]; then
            cmd.exe //c ".\\tests\\run-e2e-basic.bat" || {
                echo ""
                echo "❌ Basic E2E smoke tests failed. Push aborted."
                echo "   Run 'tests\\run-e2e-basic.bat' for details."
                echo "   To bypass: git push --no-verify"
                exit 1
            }
        else
            echo "⚠️  tests/run-e2e-basic.bat not found, skipping E2E"
        fi
        ;;
esac

echo ""
echo "✅ All pre-push checks passed"
exit 0
