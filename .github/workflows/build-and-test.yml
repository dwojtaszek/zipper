name: Build and Test

on:
  push:
    branches: ['**']
    tags: ['v*']
  pull_request:
    branches: [main]

permissions:
  contents: read

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - uses: actions/checkout@v6
      - name: Set Version
        id: version
        shell: bash
        run: |
          if [[ $GITHUB_REF == refs/tags/v* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
            echo "Version from tag: $VERSION"
          else
            VERSION="0.0.0-dev"
            echo "Defaulting to version: $VERSION"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

  lint:
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-dotnet@v5
        with:
          dotnet-version: 8.0.x
      - name: Lint code style
        run: |
          dotnet tool install -g dotnet-format
          dotnet format --verify-no-changes

  build:
    needs: [prepare, lint]
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux-x64
          - os: windows-latest
            platform: win-x64
          - os: macos-latest
            platform: osx-arm64

    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-dotnet@v5
        with:
          dotnet-version: 8.0.x
          cache: true
          cache-dependency-path: |
            Zipper/packages.lock.json
            Zipper/Zipper.Tests/packages.lock.json

      - name: Restore dependencies
        run: dotnet restore zipper.sln

      - name: Cache build
        id: cache-build
        uses: actions/cache@v5.0.1
        with:
          path: publish/${{ matrix.platform }}
          key: ${{ runner.os }}-build-${{ matrix.platform }}-${{ hashFiles('**/*.csproj', '**/packages.lock.json') }}
          restore-keys: |
            ${{ runner.os }}-build-${{ matrix.platform }}-

      - name: Build and publish
        if: steps.cache-build.outputs.cache-hit != 'true'
        run: |
          dotnet build zipper.sln -c Release --no-restore
          dotnet publish Zipper/Zipper.csproj -c Release -r ${{ matrix.platform }} --self-contained true -o publish/${{ matrix.platform }} -p:Version=${{ needs.prepare.outputs.version }} --no-restore
          rm -f publish/${{ matrix.platform }}/*.pdb

          case "${{ matrix.platform }}" in
            win-x64) mv publish/${{ matrix.platform }}/Zipper.exe publish/${{ matrix.platform }}/zipper-win-x64.exe ;;
            linux-x64) mv publish/${{ matrix.platform }}/Zipper publish/${{ matrix.platform }}/zipper-linux-x64 ;;
            osx-arm64) mv publish/${{ matrix.platform }}/Zipper publish/${{ matrix.platform }}/zipper-osx-arm64 ;;
          esac
        shell: bash

      - uses: actions/upload-artifact@v6
        with:
          name: zipper-${{ matrix.platform }}
          path: publish/${{ matrix.platform }}
          retention-days: 7

  test:
    needs: build
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux-x64
          - os: windows-latest
            platform: win-x64
          - os: macos-latest
            platform: osx-arm64

    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-dotnet@v5
        with:
          dotnet-version: 8.0.x

      - uses: actions/download-artifact@v7
        with:
          name: zipper-${{ matrix.platform }}
          path: artifacts

      - name: Restore test dependencies
        run: dotnet restore Zipper/Zipper.Tests/Zipper.Tests.csproj

      - name: Build test project
        run: dotnet build Zipper/Zipper.Tests/Zipper.Tests.csproj -c Debug --no-restore

      - name: Run unit tests
        run: dotnet test Zipper/Zipper.Tests/Zipper.Tests.csproj --logger "console;verbosity=detailed" --no-build

      - name: Run E2E tests
        run: |
          if [ "$RUNNER_OS" == "Windows" ]; then
            ./tests/run-tests.bat
          else
            chmod +x ./tests/run-tests.sh && ./tests/run-tests.sh
          fi
        shell: bash

  auto-tag:
    needs: [prepare, lint, build, test]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && !contains(github.event.head_commit.message, '[skip ci]')
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: Bump and Tag
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "Latest tag: $LATEST_TAG"

          VERSION=${LATEST_TAG#v}
          IFS='.' read -r major minor patch <<< "$VERSION"

          # Handle case where split fails (e.g. non-semver tag)
          if [ -z "$major" ] || [ -z "$minor" ] || [ -z "$patch" ]; then
             echo "Could not parse version: $VERSION"
             major=0
             minor=0
             patch=0
          fi

          NEW_PATCH=$((patch + 1))
          NEW_TAG="v$major.$minor.$NEW_PATCH"

          echo "New tag: $NEW_TAG"

          git tag $NEW_TAG
          git push origin $NEW_TAG

  release:
    needs: [prepare, lint, build, test]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v6
      - uses: actions/download-artifact@v7
        with:
          path: artifacts

      - uses: softprops/action-gh-release@v2.5.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          draft: false
          prerelease: false
          files: |
            artifacts/zipper-win-x64/zipper-win-x64.exe
            artifacts/zipper-linux-x64/zipper-linux-x64
            artifacts/zipper-osx-arm64/zipper-osx-arm64
