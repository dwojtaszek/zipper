name: Build and Test
# Unified workflow replacing separate build.yml and test.yml workflows

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

permissions:
  contents: read

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.VERSION }}
    steps:
    - uses: actions/checkout@v5
    - name: Set Version
      id: version
      run: echo "VERSION=$(cat .version)" >> $GITHUB_OUTPUT
      shell: bash

  lint:
    needs: prepare
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v5

    - name: Setup .NET
      uses: actions/setup-dotnet@v5
      with:
        dotnet-version: 8.0.x

    - name: Lint code style
      if: hashFiles('.editorconfig') != ''
      run: |
        dotnet tool install -g dotnet-format
        dotnet format --verify-no-changes

  build:
    needs: [prepare, lint]
    runs-on: ${{ matrix.os }}
    outputs:
      build_executed: ${{ steps.check_build_status.outputs.any_build_run }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux-x64
          - os: windows-latest
            platform: win-x64
          - os: macos-latest
            platform: osx-arm64

    steps:
    - name: Checkout repository
      uses: actions/checkout@v5

    - name: Setup .NET
      uses: actions/setup-dotnet@v5
      with:
        dotnet-version: 8.0.x
        cache: true
        cache-dependency-path: |
          Zipper/packages.lock.json
          Zipper/Zipper.Tests/packages.lock.json

    - name: Restore dependencies
      run: dotnet restore zipper.sln

    - name: Cache ${{ matrix.platform }} build
      id: cache-build
      uses: actions/cache@v4.3.0
      with:
        path: publish/${{ matrix.platform }}
        key: ${{ runner.os }}-build-${{ matrix.platform }}-${{ hashFiles('**/*.cs', '**/*.csproj') }}
        restore-keys: |
          ${{ runner.os }}-build-${{ matrix.platform }}-

    - name: Build for ${{ matrix.platform }}
      if: steps.cache-build.outputs.cache-hit != 'true'
      run: |
        dotnet build zipper.sln -c Release --no-restore
        dotnet publish Zipper/Zipper.csproj -c Release -r ${{ matrix.platform }} --self-contained true -o publish/${{ matrix.platform }} -p:InformationalVersion=${{ needs.prepare.outputs.version }} --no-restore
        rm -f publish/${{ matrix.platform }}/*.pdb

        # Rename executable to platform-specific name
        if [ "${{ matrix.platform }}" = "win-x64" ]; then
          mv publish/${{ matrix.platform }}/Zipper.exe publish/${{ matrix.platform }}/zipper-win-x64.exe
        elif [ "${{ matrix.platform }}" = "linux-x64" ]; then
          mv publish/${{ matrix.platform }}/Zipper publish/${{ matrix.platform }}/zipper-linux-x64
        elif [ "${{ matrix.platform }}" = "osx-arm64" ]; then
          mv publish/${{ matrix.platform }}/Zipper publish/${{ matrix.platform }}/zipper-osx-arm64
        fi
      shell: bash

    - name: Upload ${{ matrix.platform }} artifact
      uses: actions/upload-artifact@v5
      with:
        name: zipper-${{ matrix.platform }}
        path: publish/${{ matrix.platform }}
        retention-days: 7

    - name: Check build status
      id: check_build_status
      run: |
        echo "Build completed for ${{ matrix.platform }}"

  test:
    needs: build
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux-x64
          - os: windows-latest
            platform: win-x64
          - os: macos-latest
            platform: osx-arm64

    steps:
    - name: Checkout repository
      uses: actions/checkout@v5

    - name: Setup .NET
      uses: actions/setup-dotnet@v5
      with:
        dotnet-version: 8.0.x

    - name: Download ${{ matrix.platform }} build artifacts
      uses: actions/download-artifact@v6
      with:
        name: zipper-${{ matrix.platform }}
        path: artifacts

    - name: List downloaded artifacts
      run: ls -R artifacts

    - name: Restore test dependencies
      run: dotnet restore Zipper/Zipper.Tests/Zipper.Tests.csproj

    - name: Build test project
      run: dotnet build Zipper/Zipper.Tests/Zipper.Tests.csproj -c Debug --no-restore

    - name: Run unit tests
      run: dotnet test Zipper/Zipper.Tests/Zipper.Tests.csproj --logger "console;verbosity=detailed" --no-build

    - name: Run end-to-end tests
      if: runner.os != 'Windows'
      run: chmod +x ./tests/run-tests.sh && ./tests/run-tests.sh

    - name: Run end-to-end tests on Windows
      if: runner.os == 'Windows'
      run: .\tests\run-tests.bat
      shell: cmd

  release:
    needs: [prepare, lint, build, test]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master'
    permissions:
      contents: write
    steps:
    - name: Checkout repository
      uses: actions/checkout@v5
      with:
        persist-credentials: true
    - name: Download all build artifacts
      uses: actions/download-artifact@v6
      with:
        path: artifacts
    - name: List downloaded artifacts
      run: ls -R artifacts
    - name: Create Release
      id: create_release
      uses: softprops/action-gh-release@v2.4.2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v${{ needs.prepare.outputs.version }}
        name: Release ${{ needs.prepare.outputs.version }}
        draft: false
        prerelease: false
        files: |
          artifacts/zipper-win-x64/zipper-win-x64.exe
          artifacts/zipper-linux-x64/zipper-linux-x64
          artifacts/zipper-osx-arm64/zipper-osx-arm64
    - name: Bump version
      if: success()
      run: |
        # Configure git user
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'

        # Pull latest changes to avoid conflicts
        echo "Pulling latest changes from master..."
        git pull origin master

        # Read and validate current version
        version=$(cat .version)
        echo "Current version: $version"

        if [[ ! $version =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
          echo "âŒ Invalid version format: $version"
          echo "Expected format: X.Y.Z where X, Y, Z are numbers"
          exit 1
        fi

        # Parse version components safely
        major=$(echo $version | cut -d. -f1)
        minor=$(echo $version | cut -d. -f2)
        build=$(echo $version | cut -d. -f3)

        # Increment build number
        new_build=$((build + 1))
        new_version="$major.$minor.$new_build"

        echo "ğŸ“¦ Bumping version from $version to $new_version"

        # Check if version already exists in git tags (prevent duplicates)
        if git rev-parse "v$new_version" >/dev/null 2>&1; then
          echo "âš ï¸ Version $new_version already exists as a tag, skipping bump"
          exit 0
        fi

        # Update version file
        echo $new_version > .version

        # Commit the change
        git add .version
        git commit -m "chore(release): bump version to $new_version [skip ci]"

        # Push with conflict handling
        echo "ğŸš€ Pushing version bump to master..."

        # Try direct push first (most common case)
        if git push origin master; then
          echo "âœ… Version bump pushed successfully"
        else
          echo "âš ï¸ Push failed, attempting to resolve conflicts..."

          # Pull and merge any conflicting changes
          git pull --no-rebase origin master

          # Try push again after conflict resolution
          if git push origin master; then
            echo "âœ… Version bump pushed successfully after conflict resolution"
          else
            echo "âŒ Failed to push version bump after conflict resolution"
            echo "This usually indicates concurrent version bump attempts"
            echo "Manual intervention may be required"
            exit 1
          fi
        fi

        echo "ğŸ‰ Successfully bumped version to $new_version"
