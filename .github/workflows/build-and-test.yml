name: Build and Test

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - uses: actions/checkout@v6
      - name: Set Version
        id: version
        run: echo "version=$(cat .version)" >> $GITHUB_OUTPUT

  lint:
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-dotnet@v5
        with:
          dotnet-version: 8.0.x
      - name: Lint code style
        run: |
          dotnet tool install -g dotnet-format
          dotnet format --verify-no-changes

  build:
    needs: [prepare, lint]
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux-x64
          - os: windows-latest
            platform: win-x64
          - os: macos-latest
            platform: osx-arm64

    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-dotnet@v5
        with:
          dotnet-version: 8.0.x
          cache: true
          cache-dependency-path: |
            Zipper/packages.lock.json
            Zipper/Zipper.Tests/packages.lock.json

      - name: Restore dependencies
        run: dotnet restore zipper.sln

      - name: Cache build
        id: cache-build
        uses: actions/cache@v5.0.1
        with:
          path: publish/${{ matrix.platform }}
          key: ${{ runner.os }}-build-${{ matrix.platform }}-${{ hashFiles('**/*.csproj', '**/packages.lock.json') }}
          restore-keys: |
            ${{ runner.os }}-build-${{ matrix.platform }}-

      - name: Build and publish
        if: steps.cache-build.outputs.cache-hit != 'true'
        run: |
          dotnet build zipper.sln -c Release --no-restore
          dotnet publish Zipper/Zipper.csproj -c Release -r ${{ matrix.platform }} --self-contained true -o publish/${{ matrix.platform }} -p:InformationalVersion=${{ needs.prepare.outputs.version }} --no-restore
          rm -f publish/${{ matrix.platform }}/*.pdb

          case "${{ matrix.platform }}" in
            win-x64) mv publish/${{ matrix.platform }}/Zipper.exe publish/${{ matrix.platform }}/zipper-win-x64.exe ;;
            linux-x64) mv publish/${{ matrix.platform }}/Zipper publish/${{ matrix.platform }}/zipper-linux-x64 ;;
            osx-arm64) mv publish/${{ matrix.platform }}/Zipper publish/${{ matrix.platform }}/zipper-osx-arm64 ;;
          esac
        shell: bash

      - uses: actions/upload-artifact@v6
        with:
          name: zipper-${{ matrix.platform }}
          path: publish/${{ matrix.platform }}
          retention-days: 7

  test:
    needs: build
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux-x64
          - os: windows-latest
            platform: win-x64
          - os: macos-latest
            platform: osx-arm64

    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-dotnet@v5
        with:
          dotnet-version: 8.0.x

      - uses: actions/download-artifact@v7
        with:
          name: zipper-${{ matrix.platform }}
          path: artifacts

      - name: Restore test dependencies
        run: dotnet restore Zipper/Zipper.Tests/Zipper.Tests.csproj

      - name: Build test project
        run: dotnet build Zipper/Zipper.Tests/Zipper.Tests.csproj -c Debug --no-restore

      - name: Run unit tests
        run: dotnet test Zipper/Zipper.Tests/Zipper.Tests.csproj --logger "console;verbosity=detailed" --no-build

      - name: Run E2E tests
        run: |
          if [ "$RUNNER_OS" == "Windows" ]; then
            ./tests/run-tests.bat
          else
            chmod +x ./tests/run-tests.sh && ./tests/run-tests.sh
          fi
        shell: bash

  release:
    needs: [prepare, lint, build, test]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && !contains(github.event.head_commit.message, '[skip ci]')
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v6
      - uses: actions/download-artifact@v7
        with:
          path: artifacts

      - uses: softprops/action-gh-release@v2.5.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ needs.prepare.outputs.version }}
          name: Release ${{ needs.prepare.outputs.version }}
          draft: false
          prerelease: false
          files: |
            artifacts/zipper-win-x64/zipper-win-x64.exe
            artifacts/zipper-linux-x64/zipper-linux-x64
            artifacts/zipper-osx-arm64/zipper-osx-arm64

      - name: Bump version
        if: success()
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

          git pull origin main

          version=$(cat .version)

          # Validate version format
          chmod +x .github/scripts/validate-version.sh
          .github/scripts/validate-version.sh "$version"

          IFS='.' read -r major minor build <<< "$version"
          new_build=$((build + 1))
          new_version="$major.$minor.$new_build"

          if git rev-parse "v$new_version" >/dev/null 2>&1; then
            echo "Version $new_version already exists, skipping"
            exit 0
          fi

          echo $new_version > .version
          git add .version
          git commit -m "chore(release): bump version to $new_version [skip ci]"

          if ! git push origin main; then
            sleep 5
            git pull --no-rebase origin main
            git push origin main || { echo "Push failed after retry"; exit 1; }
          fi
