name: Build and Test
# Unified workflow replacing separate build.yml and test.yml workflows

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Check .editorconfig exists
      run: |
        if [ -f ".editorconfig" ]; then
          echo ".editorconfig found"
        else
          echo "WARNING: .editorconfig not found, skipping linting"
          echo "::warning::.editorconfig file not found"
        fi

    - name: Lint code style
      if: hashFiles('.editorconfig') != ''
      run: |
        echo "Checking code style with .editorconfig"
        # Check for common C# style violations
        if grep -r "  $" . --include="*.cs" --exclude-dir=bin --exclude-dir=obj; then
          echo "ERROR: Trailing whitespace found"
          exit 1
        fi

        if grep -r $'\t' . --include="*.cs" --exclude-dir=bin --exclude-dir=obj; then
          echo "ERROR: Tab characters found"
          exit 1
        fi

        echo "Linting passed - no style violations found"

  build:
    needs: lint
    runs-on: ${{ matrix.os }}
    outputs:
      build_executed: ${{ steps.check_build_status.outputs.any_build_run }}
      version: ${{ steps.version.outputs.VERSION }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux-x64
          - os: windows-latest
            platform: win-x64
          - os: macos-latest
            platform: osx-arm64

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set Version
      id: version
      run: echo "VERSION=$(cat .version | tr -d '[:space:]').${{ github.run_number }}" >> $GITHUB_OUTPUT

    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: 8.0.x
        cache: true
        cache-dependency-path: Zipper/packages.lock.json

    - name: Restore dependencies
      run: dotnet restore Zipper/Zipper.csproj

    - name: Cache ${{ matrix.platform }} build
      id: cache-build
      uses: actions/cache@v3
      with:
        path: publish/${{ matrix.platform }}
        key: ${{ runner.os }}-build-${{ matrix.platform }}-${{ hashFiles('**/*.cs', '**/*.csproj') }}
        restore-keys: |
          ${{ runner.os }}-build-${{ matrix.platform }}-

    - name: Build for ${{ matrix.platform }}
      if: steps.cache-build.outputs.cache-hit != 'true'
      run: |
        dotnet publish Zipper/Zipper.csproj -c Release -r ${{ matrix.platform }} --self-contained true -o publish/${{ matrix.platform }} /p:InformationalVersion=${{ steps.version.outputs.VERSION }}
        rm publish/${{ matrix.platform }}/*.pdb

        # Rename executable to platform-specific name
        if [ "${{ matrix.platform }}" = "win-x64" ]; then
          mv publish/${{ matrix.platform }}/Zipper.exe publish/${{ matrix.platform }}/zipper-win-x64.exe
        elif [ "${{ matrix.platform }}" = "linux-x64" ]; then
          mv publish/${{ matrix.platform }}/Zipper publish/${{ matrix.platform }}/zipper-linux-x64
        elif [ "${{ matrix.platform }}" = "osx-arm64" ]; then
          mv publish/${{ matrix.platform }}/Zipper publish/${{ matrix.platform }}/zipper-osx-arm64
        fi

    - name: Upload ${{ matrix.platform }} artifact
      uses: actions/upload-artifact@v4
      with:
        name: zipper-${{ matrix.platform }}
        path: publish/${{ matrix.platform }}
        retention-days: 7

    - name: Check build status
      id: check_build_status
      run: |
        echo "Build completed for ${{ matrix.platform }}"

  test:
    needs: build
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux-x64
          - os: windows-latest
            platform: win-x64
          - os: macos-latest
            platform: osx-arm64

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: 8.0.x

    - name: Download ${{ matrix.platform }} build artifacts
      uses: actions/download-artifact@v4
      with:
        name: zipper-${{ matrix.platform }}
        path: artifacts

    - name: List downloaded artifacts
      run: ls -R artifacts

    - name: Run tests on Linux and macOS
      if: runner.os != 'Windows'
      run: chmod +x ./tests/run-tests.sh && ./tests/run-tests.sh

    - name: Run tests on Windows
      if: runner.os == 'Windows'
      run: .\tests\run-tests.bat
      shell: cmd

  release:
    needs: [lint, build, test]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master'
    permissions:
      contents: write
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Download all build artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: List downloaded artifacts
      run: ls -R artifacts

    - name: Create Release
      id: create_release
      uses: softprops/action-gh-release@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v${{ needs.build.outputs.version }}
        name: Release ${{ needs.build.outputs.version }}
        draft: false
        prerelease: false
        files: |
          artifacts/zipper-win-x64/zipper-win-x64.exe
          artifacts/zipper-linux-x64/zipper-linux-x64
          artifacts/zipper-osx-arm64/zipper-osx-arm64