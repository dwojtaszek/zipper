name: Build and Test

on:
  push:
    branches: ['**']
    tags: ['v*']
  pull_request:
    branches: [main]

permissions:
  contents: read

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - uses: actions/checkout@v6
      - name: Set Version
        id: version
        shell: bash
        run: |
          if [[ $GITHUB_REF == refs/tags/v* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
            echo "Version from tag: $VERSION"
          else
            VERSION="0.0.0-dev"
            echo "Defaulting to version: $VERSION"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

  lint:
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-dotnet@v5
        with:
          dotnet-version: 8.0.x
      - name: Lint code style
        run: |
          dotnet tool install -g dotnet-format
          dotnet format --verify-no-changes

  build:
    needs: [prepare, lint]
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux-x64
          - os: windows-latest
            platform: win-x64
          - os: macos-latest
            platform: osx-arm64

    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-dotnet@v5
        with:
          dotnet-version: 8.0.x
          cache: true
          cache-dependency-path: |
            src/packages.lock.json
            src/Zipper.Tests/packages.lock.json

      - name: Restore dependencies
        run: dotnet restore zipper.sln

      - name: Cache build
        id: cache-build
        uses: actions/cache@v5.0.3
        with:
          path: publish/${{ matrix.platform }}
          key: ${{ runner.os }}-build-${{ matrix.platform }}-${{ needs.prepare.outputs.version }}-${{ hashFiles('**/*.csproj', '**/packages.lock.json') }}
          restore-keys: |
            ${{ runner.os }}-build-${{ matrix.platform }}-

      - name: Build and publish
        if: steps.cache-build.outputs.cache-hit != 'true'
        run: |
          dotnet build zipper.sln -c Release --no-restore
          dotnet publish src/Zipper.csproj -c Release -r ${{ matrix.platform }} --self-contained true -o publish/${{ matrix.platform }} -p:Version=${{ needs.prepare.outputs.version }} --no-restore
          rm -f publish/${{ matrix.platform }}/*.pdb

          case "${{ matrix.platform }}" in
            win-x64) mv publish/${{ matrix.platform }}/Zipper.exe publish/${{ matrix.platform }}/zipper-win-x64.exe ;;
            linux-x64) mv publish/${{ matrix.platform }}/Zipper publish/${{ matrix.platform }}/zipper-linux-x64 ;;
            osx-arm64) mv publish/${{ matrix.platform }}/Zipper publish/${{ matrix.platform }}/zipper-osx-arm64 ;;
          esac
        shell: bash

      - uses: actions/upload-artifact@v6
        with:
          name: zipper-${{ matrix.platform }}
          path: publish/${{ matrix.platform }}
          retention-days: 7

  test:
    needs: build
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux-x64
          - os: windows-latest
            platform: win-x64
          - os: macos-latest
            platform: osx-arm64

    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-dotnet@v5
        with:
          dotnet-version: 8.0.x

      - uses: actions/download-artifact@v7
        with:
          name: zipper-${{ matrix.platform }}
          path: artifacts

      - name: Restore test dependencies
        run: dotnet restore src/Zipper.Tests/Zipper.Tests.csproj

      - name: Build test project
        run: dotnet build src/Zipper.Tests/Zipper.Tests.csproj -c Debug --no-restore

      - name: Run unit tests
        run: dotnet test src/Zipper.Tests/Zipper.Tests.csproj --logger "console;verbosity=detailed" --no-build

      - name: Run unit tests with coverage (Linux only)
        if: runner.os == 'Linux'
        run: |
          dotnet test src/Zipper.Tests/Zipper.Tests.csproj \
            --configuration Debug \
            --no-build \
            --collect:"XPlat Code Coverage" \
            --results-directory ./TestResults

      - name: Generate and validate coverage report (Linux only)
        if: runner.os == 'Linux'
        run: |
          # Install report generator
          dotnet tool install --global dotnet-reportgenerator-globaltool
          export PATH="$PATH:$HOME/.dotnet/tools"
          
          # Generate reports
          reportgenerator \
            -reports:TestResults/*/coverage.cobertura.xml \
            -targetdir:TestResults/coverage-report \
            -reporttypes:"Html;TextSummary"
          
          # Display summary
          cat TestResults/coverage-report/Summary.txt
          
          # Extract line coverage percentage
          COVERAGE=$(grep "Line coverage:" TestResults/coverage-report/Summary.txt | grep -oP '\d+(\.\d+)?%' | head -1 | sed 's/%//')
          echo "Current coverage: $COVERAGE%"
          
          # Check if coverage is >= 80%
          if (( $(echo "$COVERAGE < 80" | bc -l) )); then
            echo "❌ ERROR: Code coverage is below 80% (current: $COVERAGE%)"
            echo "Please add more tests to increase coverage."
            exit 1
          else
            echo "✅ Coverage check passed: $COVERAGE% >= 80%"
          fi

      - name: Run E2E tests
        run: |
          if [ "$RUNNER_OS" == "Windows" ]; then
            ./tests/run-tests.bat
          else
            chmod +x ./tests/run-tests.sh && ./tests/run-tests.sh
          fi
        shell: bash

  tag-and-release:
    needs: [prepare, lint, build, test]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && !contains(github.event.head_commit.message, '[skip ci]')
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - uses: actions/download-artifact@v7
        with:
          path: artifacts

      - name: Bump and Tag
        id: tag_step
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

          # Find the highest semver tag (sort -V for version sorting)
          LATEST_TAG=$(git tag -l 'v*' | sort -V | tail -1)
          if [ -z "$LATEST_TAG" ]; then
            LATEST_TAG="v0.0.0"
          fi
          echo "Latest tag: $LATEST_TAG"

          VERSION=${LATEST_TAG#v}
          IFS='.' read -r major minor patch <<< "$VERSION"

          # Handle case where split fails (e.g. non-semver tag)
          if [ -z "$major" ] || [ -z "$minor" ] || [ -z "$patch" ]; then
             echo "Could not parse version: $VERSION"
             major=0
             minor=0
             patch=0
          fi

          NEW_PATCH=$((patch + 1))
          NEW_TAG="v$major.$minor.$NEW_PATCH"

          echo "New tag: $NEW_TAG"

          # Check if tag already exists
          if git rev-parse "$NEW_TAG" >/dev/null 2>&1; then
            echo "Tag $NEW_TAG already exists, skipping"
            exit 0
          fi

          git tag "$NEW_TAG"
          git push origin "$NEW_TAG"
          echo "tag=$NEW_TAG" >> $GITHUB_OUTPUT

      - name: Create Release
        if: steps.tag_step.outputs.tag != ''
        uses: softprops/action-gh-release@v2.5.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.tag_step.outputs.tag }}
          name: Release ${{ steps.tag_step.outputs.tag }}
          draft: false
          prerelease: false
          files: |
            artifacts/zipper-win-x64/zipper-win-x64.exe
            artifacts/zipper-linux-x64/zipper-linux-x64
            artifacts/zipper-osx-arm64/zipper-osx-arm64

  release:
    needs: [prepare, lint, build, test]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v6
      - uses: actions/download-artifact@v7
        with:
          path: artifacts

      - uses: softprops/action-gh-release@v2.5.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          draft: false
          prerelease: false
          files: |
            artifacts/zipper-win-x64/zipper-win-x64.exe
            artifacts/zipper-linux-x64/zipper-linux-x64
            artifacts/zipper-osx-arm64/zipper-osx-arm64
